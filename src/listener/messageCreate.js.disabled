module.exports = {
    name: 'messageCreate',
    once: false,
    execute(message) {
        if (message.author.bot) return;
        const table = new db.table(message.guild.id);

        if (message.channel.type === 'DM') {
            let active = await table.get(`support_${message.author.id}`);
            let block = await table.get(`blocked_${message.author.id}`);
            let hold = await table.get(`hold_${message.author.id}`);
            if (config.dmUsers === false)
                return message.author.send(
                    'Hey! Sorry, but the modmail is currently closed.'
                );
            if (block === true)
                return message.author.send(
                    'You are not allowed to use modmail.'
                );
            if (hold === true)
                return message.author.send(
                    'The support team put your ticket on hold. Please wait until they get back to you.'
                );
            let guild = await client.guilds.fetch(config.guild);
            let tc = await guild.channels.fetch(config.ticketCategory);
            let channel,
                found = true;
            if (active === null) {
                await table.add('Tickets', 1);
                let ticket = await table.get('Tickets');
                channel = await guild.channels.create(
                    `${message.author.username}`,
                    {
                        type: 'GUILD_TEXT',
                        topic: `#${ticket} | From ${message.author.username}`,
                        parent: tc,
                        reason: `${message.author.id} opened a ticket through the modmail service.`,
                        permissionOverwrites: [
                            {
                                id: guild.roles.everyone,
                                deny: [Permissions.FLAGS.VIEW_CHANNEL],
                            },
                            {
                                id: guild.roles.fetch(config.roles.mod),
                                allow: [
                                    Permissions.FLAGS.VIEW_CHANNEL,
                                    Permissions.FLAGS.SEND_MESSAGES,
                                    Permissions.FLAGS.ATTACH_FILES,
                                    Permissions.FLAGS.EMBED_LINKS,
                                    Permissions.FLAGS.READ_MESSAGE_HISTORY,
                                ],
                            },
                            {
                                id: guild.roles.fetch(config.roles.bot),
                                allow: [
                                    Permissions.FLAGS.VIEW_CHANNEL,
                                    Permissions.FLAGS.SEND_MESSAGES,
                                    Permissions.FLAGS.ATTACH_FILES,
                                    Permissions.FLAGS.EMBED_LINKS,
                                    Permissions.FLAGS.READ_MESSAGE_HISTORY,
                                ],
                            },
                        ],
                    }
                );
                let author = message.author;
                const newTicketLog = new MessageEmbed()
                    .setAuthor(author.tag, author.avatarURL())
                    .setDescription(`opened ticket #${ticket}.`)
                    .setTimestamp()
                    .setColor('0x6666ff');
                let logs = await client.channels.fetch(config.log); // set the log channel id here
                logs.send({ embeds: [newTicketLog] });
                message.author.send(
                    `Hello! Thanks for getting in touch. Our support team will get back to you quickly.`
                );
                await table.set(`support_${author.id}`, {
                    channel: channel.id,
                    target: message.author.id,
                    ticket: ticket,
                });
                await table.set(`channel_${channel.id}`, {
                    author: message.author.id,
                });
                let support = await table.get(`support_${message.author.id}`);
                let supportchannel = await table.get(`channel_${channel.id}`);
                let text = message.content;
                await channel.send({
                    content: `${message.author.username} opened this ticket.`,
                });
                await channel.send({ content: text });
                return;
            }
            channel = guild.channels.cache.get(active.channel);
            let text = message.content;
            channel.send({ content: text });
        }
    },
};
